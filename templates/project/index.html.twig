{% extends "base.html.twig" %}

{% block title %}Projects - Task Manager
{% endblock %}

{% block styles %}
	<link rel="stylesheet" href="{{ asset('css/project_index.css') }}">
{% endblock %}

{% block body %}
	<div class="container-fluid py-4">
		<div class="row mb-4">
			<div class="col-md-8">
				<h1 class="h2">Projects</h1>
				<p class="text-muted">Manage all your projects</p>
			</div>
			<div class="col-md-4 text-end">
				{% if is_granted('ROLE_ADMIN') %}
					<a href="{{ path('project_new') }}" class="btn btn-primary">
						<i class="bi bi-plus-circle"></i>
						New Project
					</a>
				{% endif %}
			</div>
		</div>

		{% if projects|length > 0 %}
			<div class="row">
				{% for project in projects %}
					<div class="col-md-6 col-lg-4 mb-4">
						<div class="card border-0 shadow-sm h-100">
							<div class="card-body">
								<div class="d-flex justify-content-between align-items-start mb-3">
									<h5 class="card-title mb-0">{{ project.name }}</h5>
									<span class="badge bg-primary">{{ project.tasks|length }}
										Tasks</span>
								</div>

								<p class="card-text text-muted">
									{% if project.description %}
										{{ project.description|length > 80 ? project.description|slice(0, 80) ~ '...' : project.description }}
									{% else %}
										<em>No description provided</em>
									{% endif %}
								</p>

								<div class="mb-3">
									<small class="text-muted">
										<strong>Start Date:</strong>
										{% if project.startDate %}
											{{ project.startDate|date('M d, Y') }}
										{% else %}
											Not set
										{% endif %}
									</small>
								</div>

								{% if project.endDate %}
									<div class="mb-3">
										<small class="text-muted">
											<strong>End Date:</strong>
											{{ project.endDate|date('M d, Y') }}
										</small>
									</div>
								{% endif %}

								<div class="progress mb-3" role="progressbar">
									{% set completed = project.tasks|filter(task => task.status == 'done')|length %}
									{% set total = project.tasks|length %}
									{% set percentage = total > 0 ? (completed / total * 100)|round : 0 %}
									<div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
								</div>
								<small class="text-muted">{{ completed }}
									of
									{{ total }}
									tasks completed</small>
							</div>
							<div class="card-footer bg-white border-top">
								<div class="d-flex flex-wrap gap-2">
									<a href="{{ path('project_show', {id: project.id}) }}" class="btn btn-sm btn-outline-primary">
										<i class="bi bi-eye"></i>
										View
									</a>
									{% if is_granted('ROLE_ADMIN') %}
										<a href="{{ path('project_edit', {id: project.id}) }}" class="btn btn-sm btn-outline-warning">
											<i class="bi bi-pencil"></i>
											Edit
										</a>
										<form method="post" action="{{ path('project_delete', {id: project.id}) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this project?');">
											<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ project.id) }}">
											<button class="btn btn-sm btn-outline-danger" type="submit">
												<i class="bi bi-trash"></i>
												Delete
											</button>
										</form>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
		{% else %}
			<div class="alert alert-info text-center py-5">
				<i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem; opacity: 0.5;"></i>
				<h5>No projects yet</h5>
				<p class="text-muted">Create your first project to get started</p>
				<a href="{{ path('project_new') }}" class="btn btn-primary">
					<i class="bi bi-plus-circle"></i>
					Create Project
				</a>
			</div>
		{% endif %}
	</div>
{% endblock %}
